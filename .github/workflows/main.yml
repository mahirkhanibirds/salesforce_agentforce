name: Deploy to Salesforce

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get list of changed files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth_url.txt
          sf org login sfdx-url -f auth_url.txt -a MySandbox

      - name: Validate changed components
        run: |
          echo "üîç Validating changed components..."
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          # Run validation deployment
          sf project deploy start \
            -d ${{ steps.changed-files.outputs.all_changed_files }} \
            -o MySandbox \
            --dry-run \
            --test-level RunLocalTests \
            --ignore-warnings \
            --verbose

      - name: Deploy only changed files
      if: success()
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          # Loop through changed files and deploy
          sf project deploy start -d ${{ steps.changed-files.outputs.all_changed_files }} -o MySandbox
